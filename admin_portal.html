<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINE Notification Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; transition: opacity 0.3s; }
    .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
    .modal-backdrop.show, .modal.show { display: block; opacity: 1; }
    .modal.show { transform: translate(-50%, -50%) scale(1); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); z-index: 100; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #10B981; }
    .toast.error { background-color: #EF4444; }
    .nav-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
  </style>
</head>
<body class="text-gray-800">

  <div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <div class="flex items-center space-x-3">
            <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAE8AEwDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD2aiquoalZ6Varcahcx20LusaPKwUFmOAMnjJJAHvTLvVNPsklkvL62t0iJEjSyrGEIGSCSeMA5oAs0VFFcQTW6XEU0ckEiCRJFcFWUjIII6gjvTd9vLbFlkhkhcEFgQVYeuehoAmorPuNZ0m1kMc+p2cTqcFXuEBB+uadLrWlQPGk2p2cbSjKEYzKDIOmRzyPcUaAaFFZ99rWlaaqtqGpWlopOB586x5P/AiKL3WtK00I2oanaWgkx5ZuJ1j3Z6YyRmgDQorPuNa0m1jWS41OzijeMSqz3CAFCcBgSehPAz1NNuNd0e0lkhutVsYJIQDKkk6qYwTgbgTxk8c0AaVFUZtX0y3uEt59QtIp3xtieZVZs9MAkE5pr6zpEfm+ZqdlH5DFJd1wimNh1DAnjHuKAL9FUY9X0yWeOCLULSSaVPMjRJlZnX+8ACSR71coAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACsfxPql5pWk+dYWjXM8jiNdqM4QHq5VfmYAdhk/TrWxRQB4Z408f614XtrC3sp5r65u0aUTzQK62yqV+b5VAJO44yD0/ADsPDvjG3sPAVnqnibWI5JJQ4M8nyGZtxA2ouM8DoB0FejUUAfO3izxhP4v8AGWlwW1pfaTZW8wzFcQmJpX3gl9rDkYAGfTFdl4w8d3vhnxhBZx28l1ZjT1ubiCKHc0zFnGFwDyQBgc8n0r1OigD5t0XxhN4J8ZatNeWV9qllPMCYreIyNEu8kqgGeMHHHrXpHh3x23irxhf22l2Vwmk2lqkhu7mFoWkkyBtVXAbHJJyBzj3r0iigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Z" alt="Nila Solutions Logo" class="h-10">
            <div>
                 <h1 class="text-3xl font-bold text-gray-900">Weighbridge LINE Notifier</h1>
                 <p class="text-gray-600 mt-1">Admin Configuration Portal</p>
            </div>
        </div>
      </div>
    </header>

    <div class="mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
      <label for="api-url" class="block text-sm font-medium text-gray-700">Backend API URL:</label>
      <div class="mt-1 flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
        <input type="text" id="api-url" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="https://your-service-name.onrender.com">
        <div id="connection-status" class="px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap"></div>
        <button id="reload-data-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-150">Connect & Reload</button>
      </div>
       <p class="mt-2 text-xs text-gray-500">ใส่ URL ของเซิร์ฟเวอร์บน Render.com ที่นี่ (ต้องเป็น https)</p>
    </div>

    <nav class="mb-6 bg-white rounded-lg shadow-sm">
      <div class="flex border-b border-gray-200">
        <button data-page="dashboard-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Dashboard</button>
        <button data-page="uploads-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Uploads</button>
        <button data-page="configs-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Configurations</button>
        <button data-page="friends-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">LINE Friends</button>
        <button data-page="log-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Activity Log</button>
      </div>
    </nav>
    
    <div id="loading-spinner" class="text-center p-8">
      <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      <p class="mt-2 text-gray-500">Loading data...</p>
    </div>

    <div id="error-display" class="hidden p-6 bg-red-50 border border-red-200 rounded-lg text-center"></div>

    <main id="main-content" class="hidden">
        
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <label for="date-filter" class="block text-sm font-medium text-gray-700">แสดงสรุปยอดสำหรับวันที่:</label>
                <input type="date" id="date-filter" class="mt-1 block w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">สรุปยอดซื้อ (BUY)</h2>
                    <div id="buy-summary" class="space-y-2"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">สรุปยอดขาย (SELL)</h2>
                    <div id="sell-summary" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Uploads Page -->
        <div id="uploads-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700">Data Uploads</h2>
                        <p class="text-sm text-gray-600 mt-1">อัปโหลดไฟล์ใหม่หรือจัดการชุดข้อมูลเก่าที่นี่</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <input type="file" id="file-input" class="hidden" accept=".xlsx">
                        <button id="upload-btn" class="w-full md:w-auto bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition">Upload New File</button>
                    </div>
                </div>
                <div id="upload-result" class="my-4"></div>
                <div class="max-h-[60vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rows</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batch-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Configurations Page -->
        <div id="configs-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Notification Configurations</h2>
                <p class="text-sm text-gray-600 mb-4">ผูกบัญชี LINE กับบริษัทลูกค้าที่นี่ รายชื่อบริษัทจะถูกเพิ่มอัตโนมัติเมื่อคุณอัปโหลดไฟล์ Excel ที่มีชีท 'Mix'</p>
                <div id="config-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <!-- LINE Friends Page -->
        <div id="friends-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h2 class="text-xl font-semibold mb-4 text-gray-700">LINE OA Friends</h2>
              <p class="text-sm text-gray-600 mb-4">รายชื่อผู้ใช้ทั้งหมดที่เพิ่มเพื่อน LINE OA ของเรา</p>
              <div id="user-list" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
        
        <!-- Activity Log Page -->
        <div id="log-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Recent Activity Log</h2>
                <div class="max-h-[70vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th></tr></thead>
                        <tbody id="log-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
  </div>

  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="config-modal" class="modal bg-white w-11/12 md:max-w-lg mx-auto rounded-lg shadow-xl">
    <div class="p-6">
      <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Edit Configuration</h3>
      <form id="config-form">
        <input type="hidden" id="config-id">
        <div class="mb-4">
          <label for="companyId" class="block text-sm font-medium text-gray-700">Company ID</label>
          <input type="text" id="companyId" name="companyId" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">LINE User IDs to Notify (one per line)</label>
          <textarea id="uuids" name="uuids" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Uxxxxxxxxxxxxxxxxx1&#10;Uxxxxxxxxxxxxxxxxx2"></textarea>
           <p class="mt-1 text-xs text-gray-500">คัดลอกจากหน้า "LINE Friends".</p>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Configuration</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const state = {
          users: [],
          configs: [],
          logs: [],
          batches: [],
          summary: {}
      };

      // --- ELEMENTS ---
      const apiUrlInput = document.getElementById('api-url');
      const loadingSpinner = document.getElementById('loading-spinner');
      const mainContent = document.getElementById('main-content');
      const errorDisplay = document.getElementById('error-display');
      const connectionStatus = document.getElementById('connection-status');
      const navButtons = document.querySelectorAll('.nav-btn');
      const pageContents = document.querySelectorAll('.page-content');
      const dateFilter = document.getElementById('date-filter');

      // Page specific elements
      const userListEl = document.getElementById('user-list');
      const configListEl = document.getElementById('config-list');
      const logListEl = document.getElementById('log-list');
      const buySummaryEl = document.getElementById('buy-summary');
      const sellSummaryEl = document.getElementById('sell-summary');
      const batchListEl = document.getElementById('batch-list');

      const uploadBtn = document.getElementById('upload-btn');
      const fileInput = document.getElementById('file-input');
      const uploadResultEl = document.getElementById('upload-result');

      const modal = document.getElementById('config-modal');
      const modalBackdrop = document.getElementById('modal-backdrop');
      const modalTitle = document.getElementById('modal-title');
      const configForm = document.getElementById('config-form');
      const configIdInput = document.getElementById('config-id');

      // --- HELPERS ---
      const getApiBaseUrl = () => apiUrlInput.value.trim().replace(/\/+$/, '');
      const joinUrl = (base, path) => `${base}${path.startsWith('/') ? '' : '/'}${path}`;
      function showToast(message, type = 'success', duration = 3000) {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = `toast show ${type}`;
          setTimeout(() => toast.classList.remove('show'), duration);
      }
      function setConnectionStatus(status, text) {
          connectionStatus.textContent = text;
          if (status === 'ok') connectionStatus.className = 'px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
          else if (status === 'error') connectionStatus.className = 'px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
          else connectionStatus.className = 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
      }
      
      // --- API WRAPPER ---
      async function apiCall(url, options = {}) {
        try {
          const response = await fetch(url, { ...options, mode: 'cors' });
          if (!response.ok) {
            let errorMsg = `HTTP error! status: ${response.status}`;
            try {
              const errorData = await response.json();
              errorMsg = errorData.message || JSON.stringify(errorData);
            } catch (e) { errorMsg = response.statusText; }
            throw new Error(errorMsg);
          }
          if (response.status === 204) return null;
          return response.json();
        } catch (error) {
          console.error('API Call failed:', error);
          showToast(`Error: ${error.message}`, 'error', 5000);
          throw error;
        }
      }

      // --- API ENDPOINTS ---
      const fetchUsers = () => apiCall(joinUrl(getApiBaseUrl(), '/api/users'));
      const fetchConfigs = () => apiCall(joinUrl(getApiBaseUrl(), '/api/configs'));
      const fetchLogs = () => apiCall(joinUrl(getApiBaseUrl(), '/api/logs'));
      const fetchBatches = () => apiCall(joinUrl(getApiBaseUrl(), '/api/uploads'));
      const fetchDashboardSummary = (date) => apiCall(joinUrl(getApiBaseUrl(), `/api/dashboard-summary?date=${date}`));
      const updateConfig = (id, data) => apiCall(joinUrl(getApiBaseUrl(), `/api/configs/${id}`), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      const uploadFileApi = (fileData, fileName) => apiCall(joinUrl(getApiBaseUrl(), '/api/upload'), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ fileData, fileName }) });
      const deleteBatchApi = (id) => apiCall(joinUrl(getApiBaseUrl(), `/api/uploads/${id}`), { method: 'DELETE' });
      const pingHealth = () => apiCall(joinUrl(getApiBaseUrl(), '/api/health'));

      // --- RENDER FUNCTIONS ---
      function renderUsers(users = []) {
        userListEl.innerHTML = '';
        if (users.length === 0) {
          userListEl.innerHTML = `<p class="text-sm text-gray-500">No users have added the LINE OA yet.</p>`;
          return;
        }
        users.forEach(user => {
          const userCard = `<div class="p-3 bg-gray-50 rounded-lg border border-gray-200"><p class="font-semibold text-gray-800">${user.displayName}</p><div class="flex items-center justify-between mt-1"><p class="text-xs text-gray-500 break-all">${user.userId}</p><button class="copy-uid-btn ml-2 text-indigo-500 hover:text-indigo-700" data-uid="${user.userId}" title="Copy ID"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg></button></div></div>`;
          userListEl.insertAdjacentHTML('beforeend', userCard);
        });
      }

      function renderConfigs(configs = []) {
        configListEl.innerHTML = '';
        if (configs.length === 0) {
          configListEl.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No companies found. Upload an Excel file with a 'Mix' sheet to get started.</p>`;
          return;
        }
        configs.forEach(config => {
          const uuidsHtml = (config.uuids || []).map(uid => `<li class="text-xs bg-gray-100 p-1 rounded font-mono break-all">${uid}</li>`).join('');
          const configCard = `<div class="border border-gray-200 rounded-lg p-4"><div class="flex justify-between items-start"><div><h4 class="font-bold text-lg text-gray-800">${config.companyId}</h4></div><button class="edit-config-btn bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200" data-config='${JSON.stringify(config)}'>Edit</button></div><div class="mt-3"><p class="text-sm font-medium text-gray-600">Notified Users:</p><ul class="space-y-1 mt-1">${uuidsHtml || '<li class="text-xs text-gray-400">No users assigned.</li>'}</ul></div></div>`;
          configListEl.insertAdjacentHTML('beforeend', configCard);
        });
      }
      
      function renderLogs(logs = []) {
          logListEl.innerHTML = '';
          if (logs.length === 0) {
              logListEl.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-sm text-gray-500">No activity recorded yet.</td></tr>`;
              return;
          }
          const statusColors = { success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800', skipped: 'bg-yellow-100 text-yellow-800', pending: 'bg-gray-100 text-gray-800' };
          logs.forEach(log => {
              const row = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[log.status] || statusColors.pending}">${log.status}</span></td><td class="px-6 py-4 text-sm text-gray-700">${log.message}</td></tr>`;
              logListEl.insertAdjacentHTML('beforeend', row);
          });
      }

      function renderDashboard(summary = {}) {
          const { buySummary = [], sellSummary = [] } = summary;
          buySummaryEl.innerHTML = '';
          sellSummaryEl.innerHTML = '';
          if (buySummary.length === 0) buySummaryEl.innerHTML = `<p class="text-sm text-gray-500">No BUY data available for this day.</p>`;
          else {
              buySummary.forEach(item => {
                  const weightInTonnes = item.totalWeight / 1000;
                  const itemEl = `<div class="flex justify-between items-center text-sm"><span class="text-gray-700">${item.product}</span><span class="font-semibold">${weightInTonnes.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ตัน</span></div>`;
                  buySummaryEl.insertAdjacentHTML('beforeend', itemEl);
              });
          }
          if (sellSummary.length === 0) sellSummaryEl.innerHTML = `<p class="text-sm text-gray-500">No SELL data available for this day.</p>`;
          else {
              sellSummary.forEach(item => {
                  const weightInTonnes = item.totalWeight / 1000;
                  const itemEl = `<div class="flex justify-between items-center text-sm"><span class="text-gray-700">${item.product}</span><span class="font-semibold">${weightInTonnes.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ตัน</span></div>`;
                  sellSummaryEl.insertAdjacentHTML('beforeend', itemEl);
              });
          }
      }

      function renderBatches(batches = []) {
          batchListEl.innerHTML = '';
          if (batches.length === 0) {
              batchListEl.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-sm text-gray-500">No files have been uploaded yet.</td></tr>`;
              return;
          }
          batches.forEach(batch => {
              const row = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(batch.uploadedAt).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${batch.fileName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${batch.rowCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-batch-btn text-red-600 hover:text-red-900" data-id="${batch._id}" data-name="${batch.fileName}">Delete</button>
                    </td>
                </tr>`;
              batchListEl.insertAdjacentHTML('beforeend', row);
          });
      }


      // --- PAGE NAVIGATION ---
      function switchPage(pageId) {
          pageContents.forEach(page => page.classList.add('hidden'));
          document.getElementById(pageId).classList.remove('hidden');
          navButtons.forEach(btn => btn.classList.remove('active'));
          document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
          
          if (pageId === 'log-page') fetchLogs().then(logs => { state.logs = logs; renderLogs(logs); });
          else if (pageId === 'dashboard-page') {
              const today = new Date().toISOString().split('T')[0];
              dateFilter.value = today;
              fetchDashboardSummary(today).then(summary => { state.summary = summary; renderDashboard(summary); });
          }
          else if (pageId === 'configs-page') fetchConfigs().then(configs => { state.configs = configs; renderConfigs(configs); });
          else if (pageId === 'friends-page') fetchUsers().then(users => { state.users = users; renderUsers(users); });
          else if (pageId === 'uploads-page') fetchBatches().then(batches => { state.batches = batches; renderBatches(batches); });
      }

      // --- MODAL FUNCTIONS ---
      function openModal(config = null) {
        configForm.reset();
        if (config) {
          modalTitle.textContent = 'Edit Configuration';
          configIdInput.value = config._id;
          configForm.companyId.value = config.companyId;
          configForm.uuids.value = (config.uuids || []).join('\n');
        } else return;
        modal.classList.add('show');
        modalBackdrop.classList.add('show');
      }
      function closeModal() {
        modal.classList.remove('show');
        modalBackdrop.classList.remove('show');
      }

      // --- EVENT HANDLERS ---
      async function handleFormSubmit(e) {
        e.preventDefault();
        const id = configIdInput.value;
        const payload = { uuids: configForm.uuids.value.split('\n').map(s => s.trim()).filter(Boolean) };
        try {
          await updateConfig(id, payload);
          showToast('Configuration updated successfully!');
          closeModal();
          fetchConfigs().then(configs => { state.configs = configs; renderConfigs(configs); });
        } catch (error) {}
      }
      
      function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => showToast('User ID copied to clipboard!')).catch(err => showToast('Failed to copy ID.', 'error'));
      }

      async function handleFileUpload(file) {
          if (!file) return;
          uploadResultEl.innerHTML = `<p class="text-sm text-indigo-600">Reading file...</p>`;
          const reader = new FileReader();
          reader.onload = async (e) => {
              try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  const allDataSheet = workbook.Sheets['All_data'];
                  const mixSheet = workbook.Sheets['Mix'];
                  if (!allDataSheet || !mixSheet) throw new Error(`Excel file must contain both 'All_data' and 'Mix' sheets.`);
                  const allDataJson = XLSX.utils.sheet_to_json(allDataSheet);
                  const mixJson = XLSX.utils.sheet_to_json(mixSheet);
                  uploadResultEl.innerHTML = `<p class="text-sm text-indigo-600">Processing ${allDataJson.length + mixJson.length} total rows... Please wait.</p>`;
                  const result = await uploadFileApi({ allData: allDataJson, mixData: mixJson }, file.name);
                  if (!result) throw new Error("Received an empty or invalid response from the server.");
                  uploadResultEl.innerHTML = `<div class="p-4 bg-green-50 text-green-800 rounded-lg"><p class="font-semibold">Upload Complete!</p><p>Companies Updated/Created: ${result.companiesProcessed}</p><p>Data Rows Saved: ${result.dataRowsSaved}</p></div>`;
                  fetchBatches().then(batches => { state.batches = batches; renderBatches(batches); });
              } catch (error) {
                   uploadResultEl.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-lg"><p class="font-semibold">Upload Failed</p><p>${error.message}</p></div>`;
              }
          };
          reader.readAsArrayBuffer(file);
      }

      async function handleDeleteBatch(e) {
          const button = e.target.closest('.delete-batch-btn');
          if (!button) return;

          const batchId = button.dataset.id;
          const fileName = button.dataset.name;
          if (confirm(`Are you sure you want to delete the data from "${fileName}"? This action cannot be undone.`)) {
              try {
                  await deleteBatchApi(batchId);
                  showToast('Batch deleted successfully!');
                  fetchBatches().then(batches => { state.batches = batches; renderBatches(batches); });
              } catch (error) {}
          }
      }


      // --- EVENT LISTENERS ---
      document.getElementById('cancel-btn').addEventListener('click', closeModal);
      modalBackdrop.addEventListener('click', closeModal);
      configForm.addEventListener('submit', handleFormSubmit);
      document.getElementById('reload-data-btn').addEventListener('click', () => initializeApp(true));
      navButtons.forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));
      uploadBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            uploadResultEl.innerHTML = '';
            handleFileUpload(file);
          }
      });
      batchListEl.addEventListener('click', handleDeleteBatch);
      dateFilter.addEventListener('change', () => {
          fetchDashboardSummary(dateFilter.value).then(summary => {
              state.summary = summary;
              renderDashboard(summary);
          });
      });
      document.body.addEventListener('click', (e) => {
        const copyBtn = e.target.closest('.copy-uid-btn');
        if (copyBtn) { copyToClipboard(copyBtn.dataset.uid); return; }
        const editBtn = e.target.closest('.edit-config-btn');
        if (editBtn) {
          try {
            const config = JSON.parse(editBtn.dataset.config);
            openModal(config);
          } catch(err) { showToast('Could not open config for editing.', 'error'); }
        }
      });
      function detectMixedContent(baseUrl) {
        try {
            const pageIsHTTPS = window.location.protocol === 'https:';
            const apiIsHTTP = new URL(baseUrl).protocol === 'http:';
            return pageIsHTTPS && apiIsHTTP;
        } catch (e) { return false; }
      }

      // --- INITIALIZATION ---
      async function initializeApp(fullReload = true) {
        if (fullReload) {
            const baseUrl = getApiBaseUrl();
            if (!baseUrl) { showToast('Please enter the Backend API URL.', 'error'); return; }
            loadingSpinner.style.display = 'block';
            mainContent.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            setConnectionStatus('checking', 'Connecting...');
            if (detectMixedContent(baseUrl)) {
                loadingSpinner.style.display = 'none';
                errorDisplay.innerHTML = `<h3 class="font-bold text-red-700">Mixed Content Error</h3><p class="text-red-600 mt-1">This page is secure (HTTPS), but the API URL is not (HTTP). Modern browsers block this for security. Please use an HTTPS URL for your backend.</p>`;
                errorDisplay.classList.remove('hidden');
                setConnectionStatus('error', 'Mixed Content');
                return;
            }
            try {
              await pingHealth();
              setConnectionStatus('ok', 'Connected');
              mainContent.classList.remove('hidden');
            } catch (error) {
              errorDisplay.innerHTML = `<h3 class="font-bold text-red-700">Failed to Load Data</h3><p class="text-red-600 mt-1">Could not connect to the backend at <strong>${baseUrl}</strong>. Please ensure the server is running, the URL is correct, and CORS is configured properly.</p>`;
              errorDisplay.classList.remove('hidden');
              setConnectionStatus('error', 'Connection Failed');
              loadingSpinner.style.display = 'none';
              return;
            } finally {
              loadingSpinner.style.display = 'none';
            }
        }
        switchPage('dashboard-page');
      }
      initializeApp();
    });
  </script>
</body>
</html>

