<!DOCTYPE html>
users.forEach(user => {
const userCard = `<div class="p-3 bg-gray-700/50 rounded-lg border border-gray-600"><p class="font-semibold text-white">${user.displayName || '-'}</p><div class="flex items-center justify-between mt-1"><p class="text-xs text-gray-400 break-all">${user.userId}</p><button class="copy-uid-btn ml-2 text-indigo-400 hover:text-indigo-300" data-uid="${user.userId}" title="Copy ID">Copy</button></div></div>`;
El.userList.insertAdjacentHTML('beforeend', userCard);
});
}


function renderConfigs(configs = []) {
El.configList.innerHTML = '';
if (!configs.length) { El.configList.innerHTML = `<p class=\"text-sm text-gray-400 text-center py-4\">No companies found. Upload an Excel file with a 'Mix' sheet to get started.</p>`; return; }
configs.forEach(config => {
const uuidsHtml = (config.uuids || []).map(uid => `<li class=\"text-xs bg-gray-700 p-1 rounded font-mono break-all\">${uid}</li>`).join('');
const configCard = `<div class=\"border border-gray-700 rounded-lg p-4\"><div class=\"flex justify-between items-start\"><div><h4 class=\"font-bold text-lg text-white\">${config.companyId}</h4></div><button class=\"edit-config-btn bg-gray-700/50 text-gray-300 px-3 py-1 rounded hover:bg-gray-600\" data-config='${JSON.stringify(config)}'>Edit</button></div><div class=\"mt-3\"><p class=\"text-sm font-medium text-gray-400\">Notified Users:</p><ul class=\"space-y-1 mt-1\">${uuidsHtml || '<li class=\"text-xs text-gray-500\">No users assigned.</li>'}</ul></div></div>`;
El.configList.insertAdjacentHTML('beforeend', configCard);
});
}


function renderDashboard(summary = {}) {
const { buySummary = [], sellSummary = [] } = summary;
El.buySummary.innerHTML = ''; El.sellSummary.innerHTML = '';
if (!buySummary.length) El.buySummary.innerHTML = `<p class=\"text-sm text-gray-400\">No BUY data available for this period.</p>`; else buySummary.forEach(item => { const t = item.totalWeight / 1000; const html = `<div class=\"flex justify-between items-center text-sm\"><span class=\"text-gray-300\">${item.product}</span><span class=\"font-semibold text-white\">${t.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} ตัน</span></div>`; El.buySummary.insertAdjacentHTML('beforeend', html); });
if (!sellSummary.length) El.sellSummary.innerHTML = `<p class=\"text-sm text-gray-400\">No SELL data available for this period.</p>`; else sellSummary.forEach(item => { const t = item.totalWeight / 1000; const html = `<div class=\"flex justify-between items-center text-sm\"><span class=\"text-gray-300\">${item.product}</span><span class=\"font-semibold text-white\">${t.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} ตัน</span></div>`; El.sellSummary.insertAdjacentHTML('beforeend', html); });
}


function renderBatches(batches = []) {
El.batchList.innerHTML = '';
if (!batches.length) { El.batchList.innerHTML = `<tr><td colspan=\"4\" class=\"text-center py-4 text-sm text-gray-400\">No files have been uploaded yet.</td></tr>`; return; }
batches.forEach(batch => {
const row = `
<tr>
<td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-400\">${new Date(batch.uploadedAt).toLocaleString()}</td>
<td class=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-white\">${batch.fileName}</td>
<td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-400\">${batch.rowCount}</td>
<td class=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2\">
<button class=\"send-batch-btn text-white px-3 py-1 rounded-md text-sm btn-primary\" data-id=\"${batch._id}\">Send</button>
<button class=\"delete-batch-btn text-red-400 hover:text-red-300\" data-id=\"${batch._id}\" data-name=\"${batch.fileName}\">Delete</button>
</td>
</tr>`;
El.batchList.insertAdjacentHTML('beforeend', row);
});
}


function switchPage(pageId) {
El.pageContents.forEach(p => p.classList.add('hidden'));
document.getElementById(pageId).classList.remove('hidden');
El.navButtons.forEach(btn => btn.classList.remove('active'));
document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
localStorage.setItem('nila:lastPage', pageId);
if (pageId === 'dashboard-page') El.refreshDashboardBtn.click();
else if (pageId === 'configs-page') API.fetchConfigs().then(c => { state.configs = c; renderConfigs(c); });
else if (pageId === 'friends-page') API.fetchUsers().then(u => { state.users = u; renderUsers(u); });
else if (pageId === 'uploads-page') API.fetchBatches().then(b => { state.batches = b; renderBatches(b); });
}


function openModal(config = null) {
El.configForm.reset();
if (config) {
document.getElementById('modal-title').textContent = 'Edit Configuration';
El.configIdInput.value = config._id;
document.getElementById('companyId').value = config.companyId;
document.getElementById('uuids').value = (config.uuids || []).join('\n');
} else return;
El.modal.classList.add('show'); El.modalBackdrop.classList.add('show');
}
function closeModal() { El.modal.classList.remove('show'); El.modalBackdrop.classList.remove('show'); }


async function handleFormSubmit(e) {
e.preventDefault(); const id = El.configIdInput.value; const payload = { uuids: document.getElementById('uuids').value.split('\n').map(s => s.trim()).filter(Boolean) };
try { await API.updateConfig(id, payload); showToast('Configuration updated successfully!'); closeModal(); API.fetchConfigs().then(c => { state.configs = c; renderConfigs(c); }); } catch (_) {}
}


function copyToClipboard(text) { if (!text) return; navigator.clipboard.writeText(text).then(() => showToast('User ID copied to clipboard!')).catch(() => showToast('Failed to copy ID.', 'error')); }


async function handleFileUpload(file) {
if (!file) return; El.uploadResult.innerHTML = `<p class=\"text-sm text-indigo-400\">Reading file...</p>`; const reader = new FileReader();
reader.onload = async (e) => {
try {
const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' });
const allDataSheet = workbook.Sheets['All_data']; const mixSheet = workbook.Sheets['Mix'];
if (!allDataSheet || !mixSheet) throw new Error(`Excel file must contain 'All_data' and 'Mix' sheets.`);
const allDataJson = XLSX.utils.sheet_to_json(allDataSheet); const mixJson = XLSX.utils.sheet_to_json(mixSheet);
El.uploadResult.innerHTML = `<p class=\"text-sm text-indigo-400\">Processing ${allDataJson.length + mixJson.length} total rows... Please wait.</p>`;
const result = await API.uploadFile({ allData: allDataJson, mixData: mixJson }, file.name);
if (!result) throw new Error('Received an empty response from the server.');
El.uploadResult.innerHTML = `<div class=\"p-4 bg-green-900/20 border border-green-500/30 text-green-300 rounded-lg\"><p class=\"font-semibold\">Upload Complete!</p><p>Companies Updated/Created: ${result.companiesProcessed}</p><p>Data Rows Saved: ${result.dataRowsSaved}</p></div>`;
API.fetchBatches().then(b => { state.batches = b; renderBatches(b); });
} catch (error) { El.uploadResult.innerHTML = `<div class=\"p-4 bg-red-900/20 border border-red-500/30 text-red-300 rounded-lg\"><p class=\"font-semibold\">Upload Failed</p><p>${error.message}</p></div>`; }
};
reader.readAsArrayBuffer(file);
}


async function handleDeleteBatch(e) {
const button = e.target.closest('.delete-batch-btn'); if (!button) return; const batchId = button.dataset.id; const name = button.dataset.name;
if (confirm(`Are you sure you want to delete all data from \"${name}\"? This action cannot be undone.`)) { try { await API.deleteBatch(batchId); showToast('Batch deleted successfully!'); API.fetchBatches().then(b => { state.batches = b; renderBatches(b); }); } catch (_) {} }
}
async function handleSendBatch(e) {
const button = e.target.closest('.send-batch-btn'); if (!button) return; button.textContent = 'Sending...'; button.disabled = true;
try { const result = await API.sendBatchReport(button.dataset.id); showToast(result.message || 'Reports sent successfully!'); } catch(_) {}
finally { button.textContent = 'Send'; button.disabled = false; }
}


// listeners
El.cancelBtn.addEventListener('click', closeModal);
El.m