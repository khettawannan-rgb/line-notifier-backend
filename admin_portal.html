<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINE Notification Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; transition: opacity 0.3s; }
    .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
    .modal-backdrop.show, .modal.show { display: block; opacity: 1; }
    .modal.show { transform: translate(-50%, -50%) scale(1); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(20px); z-index: 100; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background-color: #10B981; }
    .toast.error { background-color: #EF4444; }
    .nav-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
  </style>
</head>
<body class="text-gray-800">

  <div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Weighbridge LINE Notifier</h1>
      <p class="text-gray-600 mt-1">Admin Configuration Portal</p>
    </header>

    <div class="mb-6 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
      <label for="api-url" class="block text-sm font-medium text-gray-700">Backend API URL:</label>
      <div class="mt-1 flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
        <input type="text" id="api-url" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" value="https://your-service-name.onrender.com">
        <div id="connection-status" class="px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap"></div>
        <button id="reload-data-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-150">Connect & Reload</button>
      </div>
       <p class="mt-2 text-xs text-gray-500">ใส่ URL ของเซิร์ฟเวอร์บน Render.com ที่นี่ (ต้องเป็น https)</p>
    </div>

    <nav class="mb-6 bg-white rounded-lg shadow-sm">
      <div class="flex border-b border-gray-200">
        <button data-page="dashboard-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Dashboard</button>
        <button data-page="configs-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Configurations</button>
        <button data-page="upload-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Bulk Upload</button>
        <button data-page="log-page" class="nav-btn p-4 font-medium text-gray-500 hover:text-indigo-600 border-b-2 border-transparent transition">Activity Log</button>
      </div>
    </nav>
    
    <div id="loading-spinner" class="text-center p-8">
      <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-2 text-gray-500">Loading data...</p>
    </div>

    <div id="error-display" class="hidden p-6 bg-red-50 border border-red-200 rounded-lg text-center"></div>

    <main id="main-content" class="hidden">
        <div id="dashboard-page" class="page-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">สรุปยอดซื้อ (BUY)</h2>
                    <div id="buy-summary" class="space-y-2"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">สรุปยอดขาย (SELL)</h2>
                    <div id="sell-summary" class="space-y-2"></div>
                </div>
            </div>
        </div>
        <div id="configs-page" class="page-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Available LINE Users</h2>
                        <div id="user-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Notification Configurations</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            ตั้งค่าการผูกบัญชี LINE กับบริษัทลูกค้าที่นี่ รายชื่อบริษัทจะถูกเพิ่มอัตโนมัติเมื่อคุณอัปโหลดไฟล์ Excel ที่มีชีท 'Mix'
                        </p>
                        <div id="config-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="upload-page" class="page-content hidden">
             <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Bulk Upload Weighbridge Data</h2>
                <p class="text-sm text-gray-600 mb-4">
                    อัปโหลดไฟล์ Excel (.xlsx) ที่มีชีท 'All_data' และ 'Mix' ระบบจะบันทึกข้อมูลและอัปเดตรายชื่อบริษัทให้โดยอัตโนมัติ
                </p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx">
                    <button id="upload-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">Select Excel File</button>
                    <p id="file-name" class="mt-4 text-sm text-gray-500">No file selected.</p>
                </div>
                <div id="upload-result" class="mt-6"></div>
            </div>
        </div>
        <div id="log-page" class="page-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Recent Activity Log</h2>
                <div class="max-h-[70vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="log-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
  </div>

  <div id="modal-backdrop" class="modal-backdrop"></div>
  <div id="config-modal" class="modal bg-white w-11/12 md:max-w-lg mx-auto rounded-lg shadow-xl">
    <div class="p-6">
      <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Edit Configuration</h3>
      <form id="config-form">
        <input type="hidden" id="config-id">
        <div class="mb-4">
          <label for="companyId" class="block text-sm font-medium text-gray-700">Company ID</label>
          <input type="text" id="companyId" name="companyId" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">LINE User IDs to Notify (one per line)</label>
          <textarea id="uuids" name="uuids" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Uxxxxxxxxxxxxxxxxx1&#10;Uxxxxxxxxxxxxxxxxx2"></textarea>
           <p class="mt-1 text-xs text-gray-500">คัดลอกจาก “Available LINE Users”.</p>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancel</button>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Configuration</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTS ---
      const apiUrlInput = document.getElementById('api-url');
      const loadingSpinner = document.getElementById('loading-spinner');
      const mainContent = document.getElementById('main-content');
      const errorDisplay = document.getElementById('error-display');
      const connectionStatus = document.getElementById('connection-status');
      const navButtons = document.querySelectorAll('.nav-btn');
      const pageContents = document.querySelectorAll('.page-content');
      const userListEl = document.getElementById('user-list');
      const configListEl = document.getElementById('config-list');
      const logListEl = document.getElementById('log-list');
      const buySummaryEl = document.getElementById('buy-summary');
      const sellSummaryEl = document.getElementById('sell-summary');
      const uploadBtn = document.getElementById('upload-btn');
      const fileInput = document.getElementById('file-input');
      const fileNameEl = document.getElementById('file-name');
      const uploadResultEl = document.getElementById('upload-result');
      const modal = document.getElementById('config-modal');
      const modalBackdrop = document.getElementById('modal-backdrop');
      const modalTitle = document.getElementById('modal-title');
      const configForm = document.getElementById('config-form');
      const configIdInput = document.getElementById('config-id');

      // --- HELPERS ---
      const getApiBaseUrl = () => apiUrlInput.value.trim().replace(/\/+$/, '');
      const joinUrl = (base, path) => `${base}${path.startsWith('/') ? '' : '/'}${path}`;
      function showToast(message, type = 'success', duration = 3000) { /* ... */ }
      function setConnectionStatus(status, text) { /* ... */ }
      
      async function apiCall(url, options = {}) {
        // ... (same as previous version)
      }

      // --- API ENDPOINTS ---
      const fetchUsers = () => apiCall(joinUrl(getApiBaseUrl(), '/api/users'));
      const fetchConfigs = () => apiCall(joinUrl(getApiBaseUrl(), '/api/configs'));
      const fetchLogs = () => apiCall(joinUrl(getApiBaseUrl(), '/api/logs'));
      const fetchDashboardSummary = () => apiCall(joinUrl(getApiBaseUrl(), '/api/dashboard-summary'));
      const updateConfig = (id, data) => apiCall(joinUrl(getApiBaseUrl(), `/api/configs/${id}`), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const uploadFileApi = (fileData) => apiCall(joinUrl(getApiBaseUrl(), '/api/upload'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ fileData })
      });
      const pingHealth = () => apiCall(joinUrl(getApiBaseUrl(), '/api/health'));

      // --- RENDER FUNCTIONS ---
      function renderUsers(users = []) { /* ... */ }

      function renderConfigs(configs = []) {
        configListEl.innerHTML = '';
        if (configs.length === 0) {
          configListEl.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No companies found. Upload an Excel file with a 'Mix' sheet to get started.</p>`;
          return;
        }
        configs.forEach(config => {
          const uuidsHtml = (config.uuids || []).map(uid => `<li class="text-xs bg-gray-100 p-1 rounded font-mono break-all">${uid}</li>`).join('');
          const configCard = `
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <h4 class="font-bold text-lg text-gray-800">${config.companyId}</h4>
                </div>
                <button class="edit-config-btn bg-gray-100 text-gray-600 px-3 py-1 rounded hover:bg-gray-200" data-config='${JSON.stringify(config)}'>Edit</button>
              </div>
              <div class="mt-3">
                 <p class="text-sm font-medium text-gray-600">Notified Users:</p>
                 <ul class="space-y-1 mt-1">${uuidsHtml || '<li class="text-xs text-gray-400">No users assigned.</li>'}</ul>
              </div>
            </div>`;
          configListEl.insertAdjacentHTML('beforeend', configCard);
        });
      }
      
      function renderLogs(logs = []) { /* ... */ }
      function renderDashboard(summary = {}) { /* ... */ }

      // --- PAGE NAVIGATION ---
      function switchPage(pageId) {
          pageContents.forEach(page => page.classList.add('hidden'));
          document.getElementById(pageId).classList.remove('hidden');
          navButtons.forEach(btn => btn.classList.remove('active'));
          document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
          if (pageId === 'log-page') fetchLogs().then(renderLogs);
          if (pageId === 'dashboard-page') fetchDashboardSummary().then(renderDashboard);
          if (pageId === 'configs-page') {
              Promise.all([fetchUsers(), fetchConfigs()]).then(([users, configs]) => {
                  renderUsers(users);
                  renderConfigs(configs);
              });
          }
      }

      // --- MODAL FUNCTIONS ---
      function openModal(config = null) {
        configForm.reset();
        if (config) {
          modalTitle.textContent = 'Edit Configuration';
          configIdInput.value = config._id;
          configForm.companyId.value = config.companyId;
          configForm.uuids.value = (config.uuids || []).join('\n');
        } else {
          return; // Should not be able to add new configs manually
        }
        modal.classList.add('show');
        modalBackdrop.classList.add('show');
      }
      function closeModal() { /* ... */ }

      // --- EVENT HANDLERS ---
      async function handleFormSubmit(e) {
        e.preventDefault();
        const id = configIdInput.value;
        const payload = {
          uuids: configForm.uuids.value.split('\n').map(s => s.trim()).filter(Boolean),
        };
        try {
          await updateConfig(id, payload);
          showToast('Configuration updated successfully!');
          closeModal();
          initializeApp(false); // Re-init without full reload
        } catch (error) { /* Toast is already shown in apiCall */ }
      }
      
      function copyToClipboard(text) { /* ... */ }

      async function handleFileUpload(file) {
          if (!file) return;
          uploadResultEl.innerHTML = `<p class="text-sm text-indigo-600">Reading file...</p>`;
          const reader = new FileReader();
          reader.onload = async (e) => {
              try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, {type: 'array'});
                  
                  const allDataSheet = workbook.Sheets['All_data'];
                  const mixSheet = workbook.Sheets['Mix'];

                  if (!allDataSheet || !mixSheet) {
                      throw new Error(`Excel file must contain both 'All_data' and 'Mix' sheets.`);
                  }

                  const allDataJson = XLSX.utils.sheet_to_json(allDataSheet);
                  const mixJson = XLSX.utils.sheet_to_json(mixSheet);

                  uploadResultEl.innerHTML = `<p class="text-sm text-indigo-600">Processing ${allDataJson.length + mixJson.length} total rows... Please wait.</p>`;
                  
                  const result = await uploadFileApi({ allData: allDataJson, mixData: mixJson });
                  
                  uploadResultEl.innerHTML = `
                    <div class="p-4 bg-green-50 text-green-800 rounded-lg">
                        <p class="font-semibold">Upload Complete!</p>
                        <p>Companies Updated/Created: ${result.companiesProcessed}</p>
                        <p>Data Rows Saved: ${result.dataRowsSaved}</p>
                    </div>`;

              } catch (error) {
                   uploadResultEl.innerHTML = `
                    <div class="p-4 bg-red-50 text-red-800 rounded-lg">
                        <p class="font-semibold">Upload Failed</p>
                        <p>${error.message}</p>
                    </div>`;
              }
          };
          reader.readAsArrayBuffer(file);
      }

      // --- EVENT LISTENERS ---
      document.getElementById('cancel-btn').addEventListener('click', closeModal);
      modalBackdrop.addEventListener('click', closeModal);
      configForm.addEventListener('submit', handleFormSubmit);
      document.getElementById('reload-data-btn').addEventListener('click', () => initializeApp(true));
      navButtons.forEach(btn => btn.addEventListener('click', () => switchPage(btn.dataset.page)));
      uploadBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
              fileNameEl.textContent = file.name;
              handleFileUpload(file);
          }
      });
      document.body.addEventListener('click', (e) => { /* ... */ });
      function detectMixedContent(baseUrl) { /* ... */ }

      // --- INITIALIZATION ---
      async function initializeApp(fullReload = true) {
        if (fullReload) {
            const baseUrl = getApiBaseUrl();
            if (!baseUrl) {
              showToast('Please enter the Backend API URL.', 'error');
              return;
            }
            loadingSpinner.style.display = 'block';
            mainContent.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            setConnectionStatus('checking', 'Connecting...');
            if (detectMixedContent(baseUrl)) { /* ... */ return; }

            try {
              await pingHealth();
              setConnectionStatus('ok', 'Connected');
              mainContent.classList.remove('hidden');
            } catch (error) {
              errorDisplay.innerHTML = `...`;
              errorDisplay.classList.remove('hidden');
              setConnectionStatus('error', 'Connection Failed');
              return;
            } finally {
              loadingSpinner.style.display = 'none';
            }
        }
        switchPage('dashboard-page');
      }

      initializeApp();
    });
  </script>
</body>
</html>

